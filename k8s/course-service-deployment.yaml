apiVersion: apps/v1
kind: Deployment
metadata:
  name: course-service
  labels:
    app: course-service
spec:
  replicas: 2
  selector:
    matchLabels:
      app: course-service
  template:
    metadata:
      labels:
        app: course-service
    spec:
      # REMOVE serviceAccountName if it was here for Workload Identity
      # serviceAccountName: course-service-ksa # REMOVE THIS LINE

      containers:
      - name: course-service
        image: us-central1-docker.pkg.dev/edutrack-cc-ass-2/edutrack-docker-repo/course-service:v1.0.1
        ports:
        - containerPort: 8080
        env:
        - name: PROJECT_ID
          value: "edutrack-cc-ass-2"
        - name: DB_HOST
          value: "127.0.0.1" # <--- IMPORTANT: Connect to the sidecar proxy on localhost
        - name: DB_PORT
          value: "5433"
        - name: DB_NAME
          value: "course_db"
        - name: DB_USER
          value: "course_user"
        - name: DB_PASSWORD_FILE
          value: "/mnt/secrets-store/db_password" # Path to your K8s Secret mounted by Python app
        volumeMounts:
        - name: db-password-volume
          mountPath: "/mnt/secrets-store"
          readOnly: true

      - name: cloudsql-proxy # <--- CLOUD SQL PROXY SIDECAR CONTAINER
        image: gcr.io/cloudsql-docker/gce-proxy:1.28.0 # Use a stable version
        command:
          - "/cloud_sql_proxy"
          # Replace with your course database instance connection name: PROJECT_ID:REGION:INSTANCE_NAME
          - "-instances=edutrack-cc-ass-2:us-central1:course-db-instance=tcp:5433"
          - "-credential_file=/secrets/cloudsql/credentials.json" # <--- Path to mounted key file
        securityContext:
          runAsNonRoot: true
        volumeMounts: # <--- MOUNT VOLUME FOR PROXY CREDENTIALS
        - name: cloudsql-credentials
          mountPath: /secrets/cloudsql
          readOnly: true

      volumes:
      - name: db-password-volume # Volume for your app's DB password (from K8s Secret)
        secret:
          secretName: course-db-password-secret # Reference the K8s Secret for app's password
          items:
          - key: db_password
            path: db_password

      - name: cloudsql-credentials # <--- NEW VOLUME FOR PROXY CREDENTIALS
        secret:
          secretName: course-db-proxy-secret # Reference the K8s Secret with the SA key
          items:
          - key: credentials.json
            path: credentials.json # Mounts the 'credentials.json' key from the secret as a file

