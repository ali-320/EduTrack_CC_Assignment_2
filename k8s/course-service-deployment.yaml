apiVersion: apps/v1
kind: Deployment
metadata:
  name: course-service
  labels:
    app: course-service
spec:
  replicas: 2
  selector:
    matchLabels:
      app: course-service
  template:
    metadata:
      labels:
        app: course-service
    spec:
      serviceAccountName: course-service-ksa
      containers:
      - name: course-service
        image: us-central1-docker.pkg.dev/edutrack-cc-ass-2/edutrack-docker-repo/course-service:v1.0.0
        ports:
        - containerPort: 8080
        env:
        - name: DB_HOST
          value: "/cloudsql/edutrack-cc-ass-2:us-central1-a:course-db-instance"
        - name: DB_PORT
          value: "5433"
        - name: DB_NAME
          value: "course_db"
        - name: DB_USER
          value: "course_user"
        - name: PROJECT_ID
          value: "edutrack-cc-ass-2"
        # --- MODIFICATION STARTS HERE ---
        - name: DB_PASSWORD_FILE # New env var to point to the file
          value: "/mnt/secrets-store/db_password"
        # Remove the 'DB_PASSWORD' env var that used secretKeyRef
        # --- MODIFICATION ENDS HERE ---
        volumeMounts:
        - name: gcp-secret-volume
          mountPath: "/mnt/secrets-store"
          readOnly: true
      volumes:
      - name: gcp-secret-volume
        csi:
          driver: secrets-store-gke.csi.k8s.io
          readOnly: true
          volumeAttributes:
            secretProviderClass: course-db-secret-provider
          # --- REMOVED THE FOLLOWING SECTION ---
          # secretObjects:
          #   - secretName: course-db-password-secret
          #     type: Opaque
          #     data:
          #       - key: db_password
          #         objectName: db_password
          # --- END OF REMOVED SECTION ---

